# basic information for generating and executing this definition
SenzaInfo:
  StackName: sea-proxy
  Parameters:
    - ApplicationId:
        Description: "Application ID from kio"
    - DockerImage:
        Description: "Docker image of Sea Proxy"
    - ImageVersion:
        Description: "Docker image version of Sea Proxy"
    - MintBucket:
        Description: "The mint S3 bucket for OAuth 2.0 credentials"
    - ScalyrAccountKey:
        Description: "Scalyr account key"
SenzaComponents:

  # this basic configuration is required for the other components
  - Configuration:
      Type: Senza::StupsAutoConfiguration # auto-detect network setup

  # will create a launch configuration and auto scaling group with scaling triggers
  - AppServer:
      Type: Senza::TaupageAutoScalingGroup
      AutoScaling:
        Minimum: 2
        Maximum: 10
        MetricType: CPU
        ScaleUpThreshold: 50
        ScaleDownThreshold: 30
      InstanceType: t2.micro
      SecurityGroups:
        - app-sea-proxy
      IamRoles:
        - app-sea-proxy
      ElasticLoadBalancer: AppLoadBalancer
      TaupageConfig:
        runtime: Docker
        source: "{{Arguments.DockerImage}}:{{Arguments.ImageVersion}}"
        ports:
          9000: 9000
          7979: 7979
        mint_bucket: "{{Arguments.MintBucket}}"
        scalyr_account_key: "{{Arguments.ScalyrAccountKey}}"
        application_logrotate_filesize: 1G
        application_logrotate_period: daily
        application_logrotate_rotate: 0
        enhanced_cloudwatch_metrics: true

  # creates an ELB entry and Route53 domains to this ELB
  - AppLoadBalancer:
      Type: Senza::WeightedDnsElasticLoadBalancer
      HTTPPort: 7979
      HealthCheckPath: /health
      SecurityGroups:
        - app-sea-proxy-lb
      Scheme: internet-facing
